{% extends "base.html" %}

{% block title %}Make Payment - Institute Management System{% endblock %}

{% block content %}

<div class="dashboard-header">
    <h1>Make Payment</h1>
    {% if invoice %}
        <p>Create a new payment for Invoice #{{ invoice.invoice_number }}</p>
    {% else %}
        <p>Create a new payment</p>
    {% endif %}
</div>

<div class="row">

    <div class="col-md-8">
        <div class="card">
            <div class="card-header"><h3>Payment Details</h3></div>
            <div class="card-body">

                <form method="post" class="payment-form" id="paymentForm">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="form-errors">
                        {% for error in form.non_field_errors %}
                        <p class="error-message">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if not invoice %}
                    <div class="form-group">
                        <label for="{{ form.invoice.id_for_label }}">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </label>
                        {{ form.invoice }}
                    </div>
                    {% endif %}

                    <!-- ======= AMOUNT FIELD WITH VALIDATION ======= -->
                    <div class="form-group">
                        <label for="{{ form.amount.id_for_label }}">
                            <i class="fas fa-dollar-sign"></i> Amount
                        </label>

                        <!-- Apply HTML max only if invoice exists -->
                        {% if invoice %}
                            <input type="number" 
                                   name="{{ form.amount.name }}" 
                                   id="{{ form.amount.id_for_label }}"
                                   value="{{ form.amount.value|default_if_none:'' }}"
                                   step="0.01"
                                   min="0"
                                   max="{{ invoice.balance }}"
                                   class="form-control"
                                   required>
                        {% else %}
                            {{ form.amount }}
                        {% endif %}

                        <small class="form-text text-muted">
                            {% if invoice %}Balance due: ₹{{ invoice.balance|floatformat:2 }}{% endif %}
                        </small>

                        <!-- Dynamic client-side error -->
                        <p id="amountError" class="error-message" style="display:none;"></p>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.payment_method.id_for_label }}">
                            <i class="fas fa-credit-card"></i> Payment Method
                        </label>
                        {{ form.payment_method }}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.transaction_id.id_for_label }}">
                            <i class="fas fa-hashtag"></i> Transaction ID
                        </label>
                        {{ form.transaction_id }}
                        <small class="form-text text-muted">Reference number </small>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.notes.id_for_label }}">
                            <i class="fas fa-sticky-note"></i> Notes
                        </label>
                        {{ form.notes }}
                    </div>

                    <div class="form-actions">
                        <button type="submit" id="submitBtn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Submit Payment
                        </button>

                        <a href="{% if invoice %}{% url 'fee_invoice_detail' invoice.pk %}{% else %}{% url 'payment_list' %}{% endif %}" class="btn btn-outline">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>

                </form>

            </div>
        </div>
    </div>

    <div class="col-md-4">

        {% if invoice %}
        <div class="card">
            <div class="card-header"><h3>Invoice Summary</h3></div>
            <div class="card-body">
                <div class="invoice-summary">
                    <div class="summary-item"><span>Invoice Number</span><span>{{ invoice.invoice_number }}</span></div>
                    <div class="summary-item"><span>Student</span><span>{{ invoice.student.user.get_full_name }}</span></div>
                    <div class="summary-item"><span>Issue Date</span><span>{{ invoice.issue_date }}</span></div>
                    <div class="summary-item"><span>Due Date</span><span>{{ invoice.due_date }}</span></div>
                    <div class="summary-item"><span>Total Amount</span><span>₹{{ invoice.total_amount|floatformat:2 }}</span></div>
                    <div class="summary-item"><span>Paid Amount</span><span>₹{{ invoice.paid_amount|floatformat:2 }}</span></div>
                    <div class="summary-item"><span>Balance Due</span><span>₹{{ invoice.balance|floatformat:2 }}</span></div>
                    <div class="summary-item"><span>Status</span>
                        <span class="status-badge">{{ invoice.get_status_display }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Payment instructions kept same -->
        <div class="card">
            <div class="card-header"><h3>Payment Instructions</h3></div>
            <div class="card-body">
                <p>For cash, visit finance office.</p>
                <h4>Bank Transfer</h4>
                <ul>
                    <li>Bank: Example Bank</li>
                    <li>Account: Institute Management System</li>
                    <li>Account No: 1234567890</li>
                    <li>IFSC: EXBK0001234</li>
                </ul>
                <p>Include invoice number in reference.</p>
            </div>
        </div>

    </div>
</div>

<!-- ===== Client-Side Validation Script ===== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    const amountField = document.getElementById("{{ form.amount.id_for_label }}");
    const errorText = document.getElementById("amountError");
    const submitBtn = document.getElementById("submitBtn");

    {% if invoice %}
    const maxAmount = parseFloat("{{ invoice.balance }}");
    {% else %}
    const maxAmount = null;
    {% endif %}

    if (amountField && maxAmount !== null) {

        amountField.addEventListener("input", () => {
            const value = parseFloat(amountField.value || 0);

            if (value > maxAmount) {
                amountField.style.border = "2px solid #e74c3c";
                errorText.style.display = "block";
                errorText.innerText = `Amount cannot exceed ₹${maxAmount.toFixed(2)}`;
                submitBtn.disabled = true;
            } else {
                amountField.style.border = "";
                errorText.style.display = "none";
                submitBtn.disabled = false;
            }
        });
    }

});
</script>

<style>
.error-message {
    color: #e74c3c;
    margin-top: 4px;
    font-size: 0.85rem;
}
</style>

{% endblock %}
